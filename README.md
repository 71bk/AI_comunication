# ğŸ¤– AI Chat - GPT-like å…¨ç«¯èŠå¤©æ‡‰ç”¨

> ä¸€å€‹é¡ä¼¼ ChatGPT çš„å³æ™‚ä¸²æµèŠå¤©æ‡‰ç”¨ï¼Œæ¡ç”¨å‰å¾Œç«¯åˆ†é›¢æ¶æ§‹ï¼Œæ”¯æ´ SSE ä¸²æµå›è¦†èˆ‡æ¨¡çµ„åŒ–è¨­è¨ˆã€‚

## ğŸ“‹ å°ˆæ¡ˆç°¡ä»‹

æœ¬å°ˆæ¡ˆæ˜¯ä¸€å€‹å®Œæ•´çš„å…¨ç«¯ AI èŠå¤©æ‡‰ç”¨ï¼Œå¯¦ç¾äº†é¡ä¼¼ ChatGPT çš„å°è©±é«”é©—ã€‚å°ˆæ¡ˆæ¡ç”¨**å‰å¾Œç«¯åˆ†é›¢æ¶æ§‹**ï¼Œå¾Œç«¯æä¾› RESTful API èˆ‡ SSE ä¸²æµæœå‹™ï¼Œå‰ç«¯ä»¥ Vue 3 å»ºæ§‹éŸ¿æ‡‰å¼ UIï¼Œä¸¦å…·å‚™**å¯æ“´å±•è‡³ RAGï¼ˆæ–‡ä»¶å•ç­”ï¼‰**çš„æ¨¡çµ„åŒ–è¨­è¨ˆã€‚

### âœ¨ æ ¸å¿ƒç‰¹è‰²

- ğŸ”„ **SSE å³æ™‚ä¸²æµ**ï¼šæ¨¡æ“¬ ChatGPT é€å­—æ‰“å°å›è¦†æ•ˆæœ
- ğŸ—ï¸ **æ¨¡çµ„åŒ–æ¶æ§‹**ï¼šLLM Gateway + Adapter æ¨¡å¼ï¼Œè¼•é¬†åˆ‡æ›ä¸åŒ AI ä¾›æ‡‰å•†
- ğŸ” **å®Œæ•´èªè­‰ç³»çµ±**ï¼šJWT èªè­‰ + Spring Security
- ğŸ“¦ **çµ±ä¸€ API æ ¼å¼**ï¼šResult Envelope + å…¨åŸŸéŒ¯èª¤è™•ç†
- ğŸ¨ **ç¾ä»£åŒ– UI**ï¼šElement Plus + SCSS éŸ¿æ‡‰å¼è¨­è¨ˆ
- ğŸ“ˆ **å¯æ“´å±•è¨­è¨ˆ**ï¼šé ç•™ RAG å‡ç´šè·¯å¾‘ï¼ˆæ–‡ä»¶å•ç­”+å¼•ç”¨ï¼‰

---

## ğŸ› ï¸ æŠ€è¡“æ£§

### å¾Œç«¯ (Spring Boot)

| æŠ€è¡“ | èªªæ˜ |
|------|------|
| **Spring Boot 3.4** | æ ¸å¿ƒæ¡†æ¶ |
| **Java 21** | ç¨‹å¼èªè¨€ |
| **Spring Security** | å®‰å…¨èªè­‰ |
| **JWT (jjwt 0.12)** | Token èªè­‰ |
| **Spring Data JPA** | ORM è³‡æ–™å­˜å– |
| **MySQL 8** | é—œè¯å¼è³‡æ–™åº« |
| **SseEmitter** | Server-Sent Events ä¸²æµ |
| **Reactor Core** | éŸ¿æ‡‰å¼ç¨‹å¼è¨­è¨ˆ |
| **Lombok** | ç°¡åŒ–ç¨‹å¼ç¢¼ |

### å‰ç«¯ (Vue 3)

| æŠ€è¡“ | èªªæ˜ |
|------|------|
| **Vue 3.5** | å‰ç«¯æ¡†æ¶ |
| **Vite 7** | å»ºç½®å·¥å…· |
| **Pinia** | ç‹€æ…‹ç®¡ç† |
| **Vue Router 4** | è·¯ç”±ç®¡ç† |
| **Axios** | HTTP è«‹æ±‚å°è£ |
| **Element Plus** | UI å…ƒä»¶åº« |
| **SCSS** | æ¨£å¼é è™•ç†å™¨ |
| **Markdown-it** | Markdown æ¸²æŸ“ |
| **Highlight.js** | ç¨‹å¼ç¢¼é«˜äº® |

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
AI_comunication/
â”œâ”€â”€ ai/                          # å¾Œç«¯å°ˆæ¡ˆ (Spring Boot)
â”‚   â””â”€â”€ src/main/java/tw/bk/ai/
â”‚       â”œâ”€â”€ config/              # è¨­å®šæª” (Web, Security, CORS)
â”‚       â”œâ”€â”€ controller/          # REST API æ§åˆ¶å™¨
â”‚       â”œâ”€â”€ dto/                 # è³‡æ–™å‚³è¼¸ç‰©ä»¶
â”‚       â”œâ”€â”€ entity/              # JPA å¯¦é«”
â”‚       â”œâ”€â”€ exception/           # è‡ªå®šç¾©ä¾‹å¤–
â”‚       â”œâ”€â”€ filter/              # éæ¿¾å™¨ (JWT, TraceId)
â”‚       â”œâ”€â”€ handler/             # å…¨åŸŸä¾‹å¤–è™•ç†
â”‚       â”œâ”€â”€ repository/          # è³‡æ–™å­˜å–å±¤
â”‚       â”œâ”€â”€ result/              # çµ±ä¸€å›å‚³æ ¼å¼
â”‚       â”œâ”€â”€ security/            # JWT ç›¸é—œå…ƒä»¶
â”‚       â”œâ”€â”€ service/             # æ¥­å‹™é‚è¼¯å±¤
â”‚       â”‚   â”œâ”€â”€ auth/            # èªè­‰æœå‹™
â”‚       â”‚   â”œâ”€â”€ chat/            # èŠå¤©æœå‹™
â”‚       â”‚   â””â”€â”€ llm/             # LLM æ•´åˆæœå‹™
â”‚       â””â”€â”€ vo/                  # è¦–åœ–ç‰©ä»¶
â”‚
â”œâ”€â”€ frontend/                    # å‰ç«¯å°ˆæ¡ˆ (Vue 3)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ api/                 # API å°è£ (Axios + éŒ¯èª¤è™•ç†)
â”‚       â”œâ”€â”€ components/          # Vue å…ƒä»¶
â”‚       â”‚   â””â”€â”€ chat/            # èŠå¤©ç›¸é—œå…ƒä»¶
â”‚       â”œâ”€â”€ router/              # è·¯ç”±è¨­å®š
â”‚       â”œâ”€â”€ stores/              # Pinia ç‹€æ…‹ç®¡ç†
â”‚       â”œâ”€â”€ styles/              # SCSS æ¨£å¼
â”‚       â”œâ”€â”€ utils/               # å·¥å…·å‡½å¼ (SSE, Markdown)
â”‚       â””â”€â”€ views/               # é é¢è¦–åœ–
â”‚
â””â”€â”€ instruction/                 # å°ˆæ¡ˆæ–‡ä»¶
    â”œâ”€â”€ å°ˆæ¡ˆæ¶æ§‹æ›¸.md
    â”œâ”€â”€ æŠ€è¡“æ£§.md
    â””â”€â”€ schema.sql
```

---

## ğŸ”Œ API è¦æ ¼

### èªè­‰ API

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| POST | `/api/auth/register` | ä½¿ç”¨è€…è¨»å†Š |
| POST | `/api/auth/login` | ä½¿ç”¨è€…ç™»å…¥ |
| POST | `/api/auth/logout` | ä½¿ç”¨è€…ç™»å‡º |
| GET | `/api/auth/me` | å–å¾—ç•¶å‰ä½¿ç”¨è€…è³‡è¨Š |

### èŠå¤© API

| Method | Endpoint | èªªæ˜ |
|--------|----------|------|
| GET | `/api/chats` | å–å¾—å°è©±åˆ—è¡¨ |
| POST | `/api/chats` | å»ºç«‹æ–°å°è©± |
| GET | `/api/chats/{chatId}` | å–å¾—å°è©±è©³æƒ…ï¼ˆå«è¨Šæ¯ï¼‰ |
| PUT | `/api/chats/{chatId}/title` | æ›´æ–°å°è©±æ¨™é¡Œ |
| DELETE | `/api/chats/{chatId}` | åˆªé™¤å°è©± |
| POST | `/api/chats/{chatId}/messages:stream` | ç™¼é€è¨Šæ¯ï¼ˆSSE ä¸²æµå›è¦†ï¼‰ |

### çµ±ä¸€å›å‚³æ ¼å¼

```json
{
  "success": true,
  "code": "OK",
  "message": "success",
  "data": { ... },
  "path": "/api/chats",
  "timestamp": "2025-12-30T09:00:00+08:00",
  "traceId": "9f4c2b..."
}
```

---

## ğŸ“¡ SSE ä¸²æµå”è­°

æœ¬å°ˆæ¡ˆå¯¦ä½œäº†é¡ä¼¼ ChatGPT çš„å³æ™‚å›è¦†æ•ˆæœï¼Œæ¡ç”¨ Server-Sent Events (SSE) å”è­°ï¼š

### äº‹ä»¶é¡å‹

| Event | Type | èªªæ˜ |
|-------|------|------|
| `delta` | delta | é€å­—å›è¦†å…§å®¹ç‰‡æ®µ |
| `meta` | meta | é™„åŠ è³‡è¨Šï¼ˆRAG å¼•ç”¨ï¼‰ |
| `done` | done | ä¸²æµå®Œæˆ + Token ä½¿ç”¨é‡ |
| `error` | error | ä¸²æµéŒ¯èª¤è¨Šæ¯ |

### ç¯„ä¾‹

```json
// delta äº‹ä»¶
{ "type": "delta", "delta": "ä½ å¥½ï¼Œ" }

// done äº‹ä»¶
{ "type": "done", "usage": { "inputTokens": 123, "outputTokens": 456 } }
```

---

## ğŸ›ï¸ æ¶æ§‹è¨­è¨ˆäº®é»

### 1. LLM Gateway æ¨¡å¼

```
Controller â†’ LlmService â†’ LlmClient (interface)
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â†“                   â†“
            OpenAiLlmClient    AnthropicLlmClient
            (Adapter)          (Adapter)
```

- **è§£è€¦ä¾›æ‡‰å•†**ï¼šé€é `LlmClient` ä»‹é¢æŠ½è±¡åŒ– LLM ä¾›æ‡‰å•†
- **æ˜“æ–¼æ“´å±•**ï¼šæ–°å¢ä¾›æ‡‰å•†åªéœ€å¯¦ä½œ Adapterï¼Œç„¡éœ€ä¿®æ”¹æ ¸å¿ƒé‚è¼¯
- **é›†ä¸­ç®¡ç†**ï¼š`PromptBuilder` çµ±ä¸€çµ„è£æç¤ºè©

### 2. å…¨åŸŸçµ±ä¸€éŒ¯èª¤è™•ç†

```java
@RestControllerAdvice
GlobalExceptionHandler
    â”œâ”€â”€ BizException â†’ æ¥­å‹™é‚è¼¯éŒ¯èª¤
    â”œâ”€â”€ ValidationException â†’ åƒæ•¸é©—è­‰éŒ¯èª¤
    â”œâ”€â”€ AuthException â†’ èªè­‰/æˆæ¬ŠéŒ¯èª¤
    â””â”€â”€ Exception â†’ æœªçŸ¥éŒ¯èª¤
```

- æ‰€æœ‰ä¾‹å¤–çµ±ä¸€è½‰æ›ç‚º `Result.fail()` æ ¼å¼
- æ¯å€‹å›æ‡‰æ”œå¸¶ `traceId` ä¾¿æ–¼æ—¥èªŒè¿½è¹¤
- é©—è­‰éŒ¯èª¤å›å‚³è©³ç´°æ¬„ä½éŒ¯èª¤æ¸…å–®

### 3. å‰ç«¯ Axios å°è£

```
http.ts (Axios instance)
    â”œâ”€â”€ Request Interceptor (Token æ³¨å…¥)
    â”œâ”€â”€ Response Interceptor (éŒ¯èª¤æ­£è¦åŒ–)
    â””â”€â”€ AppError (çµ±ä¸€éŒ¯èª¤ç‰©ä»¶)
```

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

### ç’°å¢ƒéœ€æ±‚

- **Java 21+**
- **Node.js 18+**
- **MySQL 8**
- **Maven 3.9+**

### å¾Œç«¯å•Ÿå‹•

```bash
cd ai

# è¨­å®šè³‡æ–™åº«é€£ç·š (application.properties)
# åŸ·è¡Œ instruction/schema.sql å»ºç«‹è³‡æ–™è¡¨

# å•Ÿå‹•æœå‹™
./mvnw spring-boot:run
```

### å‰ç«¯å•Ÿå‹•

```bash
cd frontend

# å®‰è£ä¾è³´
npm install

# å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨
npm run dev
```

---

## ğŸ“ˆ æœªä¾†æ“´å±•ï¼šRAG å‡ç´šè·¯å¾‘

å°ˆæ¡ˆæ¶æ§‹è¨­è¨ˆå·²é ç•™ RAGï¼ˆRetrieval-Augmented Generationï¼‰å‡ç´šè·¯å¾‘ï¼š

```
Version A (MVP)              â†’    Version B (RAG)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Chat + SSE ä¸²æµå›è¦†                æ–°å¢ï¼š
                                   â”œâ”€â”€ æ–‡ä»¶ä¸Šå‚³/è§£æ
                                   â”œâ”€â”€ Chunk åˆ‡åˆ†
                                   â”œâ”€â”€ Vector Store åµŒå…¥
                                   â”œâ”€â”€ èªæ„æª¢ç´¢
                                   â””â”€â”€ Citations å¼•ç”¨
```

### æ–°å¢æ¨¡çµ„ï¼ˆä¸ç ´å£ç¾æœ‰æ¶æ§‹ï¼‰

- `IngestService`ï¼šæ–‡ä»¶è§£æèˆ‡ Embedding
- `Retriever`ï¼šå‘é‡æª¢ç´¢ä»‹é¢
- `VectorStoreClient`ï¼šå‘é‡è³‡æ–™åº«æŠ½è±¡ï¼ˆpgvector/Qdrant/Milvusï¼‰
- `CitationService`ï¼šå¼•ç”¨æ ¼å¼åŒ–

---

## ğŸ“Š è³‡æ–™åº«è¨­è¨ˆ

```sql
-- ä½¿ç”¨è€…è¡¨
users (id, email, password_hash, display_name, status, created_at, updated_at)

-- å°è©±è¡¨
chats (id, user_id, title, created_at, updated_at)

-- è¨Šæ¯è¡¨ï¼ˆé ç•™ RAG æ“´å……æ¬„ä½ï¼‰
messages (id, chat_id, role, content, provider, model, 
          token_in, token_out, metadata_json, created_at)
```

---

## ğŸ“ è¨­è¨ˆåŸå‰‡

1. **ä½è€¦åˆã€é«˜å…§èš**ï¼šæ¨¡çµ„é‚Šç•Œæ¸…æ™°ï¼Œä¾è³´æŠ½è±¡ä»‹é¢
2. **çµ±ä¸€è¦ç¯„**ï¼šAPI æ ¼å¼ã€éŒ¯èª¤è™•ç†ã€å‘½åè¦å‰‡ä¸€è‡´
3. **å¯æ¸¬è©¦æ€§**ï¼šä¾è³´æ³¨å…¥ã€ä»‹é¢æŠ½è±¡ä¾¿æ–¼å–®å…ƒæ¸¬è©¦
4. **å‘å¾Œç›¸å®¹**ï¼š`metadata_json` æ¬„ä½è¨­è¨ˆç¢ºä¿æ“´å±•ä¸ç ´å£æ—¢æœ‰åŠŸèƒ½
5. **å®‰å…¨å„ªå…ˆ**ï¼šAPI Key ä¸è½å‰ç«¯ï¼ŒJWT èªè­‰ã€TraceId è¿½è¹¤

---

## ğŸ“„ License

MIT License

---

## ğŸ‘¤ ä½œè€…

BK